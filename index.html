<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Università di Pisa — Offerta Agraria & Veterinaria</title>
  <meta name="theme-color" content="#04477B" />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const v = "3.11.174";
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${v}/pdf.worker.min.js`;
    });
  </script>

  <style>
    :root{ --unipi:#04477B; --bg:#ffffff; --text:#0b1f2a; --muted:#5c7080; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{ margin:0; background:#f6f9fc; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans"; }
    .app{ min-height:100dvh; display:flex; flex-direction:column; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e7edf3;
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px;
    }
    .title{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand{ height:28px; width:auto; object-fit:contain; }
    .title h2{
      margin:0; font-weight:800; color:var(--unipi);
      font-size:clamp(14px, 4.5vw, 18px);
      line-height:1.15;
      white-space:normal; /* consenti a capo su mobile */
    }
    .right{
      display:flex; align-items:center; gap:8px; flex-shrink:0;
    }
    .pill{ background:#eef4fa; color:var(--unipi); padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px; }
    .iconbtn{
      border:1px solid #dfe8f1; background:#fff; color:var(--unipi);
      padding:10px 12px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .iconbtn.link{ text-decoration:none; display:inline-block; }

    /* Stage + Track */
    .pageStage{
      position:relative; height:calc(100dvh - 62px);
      touch-action:pan-y pinch-zoom; overflow:hidden; background:#f6f9fc;
    }
    .pagesTrack{
      display:flex; height:100%; width:100%; transform:translateX(0);
      will-change: transform; transition: transform 280ms cubic-bezier(.22,.61,.36,1);
      align-items:center; gap:16px; padding:0 16px;
    }
    .page{ min-width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    canvas{
      box-shadow:0 12px 28px rgba(12,40,68,0.18);
      background:#fff; border-radius:18px; max-height:92%; max-width:94%;
      width:auto; height:auto; touch-action:none;
    }

    /* Cover (pagina 1 fissa) */
    .cover{
      width:min(920px, 92vw);
      border:1px solid #e9eef2; border-radius:28px; padding:32px 28px;
      box-shadow:0 10px 30px rgba(4,71,123,0.10);
      background:#fff; text-align:center;
      display:grid; gap:16px;
    }
    .cover img{ width:min(540px, 80vw); height:auto; justify-self:center; }
    .cover h1{ margin:4px 0 0; color:var(--unipi); letter-spacing:.2px; font-size:clamp(20px, 5.6vw, 34px); }
    .cover p{ margin:0; color:var(--muted); font-size:clamp(14px, 3.6vw, 16px); }
    .cover .hintCover{ color:#466784; font-size:12px; margin-top:8px; }

    /* Loading overlay */
    .loading{
      position:absolute; inset:0; background:linear-gradient(180deg,#ffffff, #f5f9ff);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
    }
    .loading img{ width:min(300px,70vw); opacity:.9; }
    .spinner{ width:34px; height:34px; border-radius:50%; border:3px solid #d9e6f3; border-top-color:var(--unipi); animation:spin 1s linear infinite; }
    .loading p{ margin:0; color:#466784; font-weight:600; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <img class="brand" src="marchio_unipi_pant541.png" alt="UniPi" />
        <h2>Offerta formativa — Agraria &amp; Veterinaria</h2>
      </div>
      <div class="right">
        <span class="pill" id="pageIndicator">— / —</span>
        <button class="iconbtn" id="prevBtn" aria-label="Pagina precedente">◀</button>
        <button class="iconbtn" id="nextBtn" aria-label="Pagina successiva">▶</button>
        <!-- Scarica PDF -->
        <a class="iconbtn link" href="PAGAGRARIA.pdf" download>Scarica PDF</a>
      </div>
    </div>

    <div class="pageStage" id="stage" role="region" aria-label="Pagine documento">
      <div class="pagesTrack" id="track">
        <!-- Pagina 1: COVER fissa -->
        <div class="page">
          <div class="cover" id="cover">
            <img src="marchio_unipi_pant541.png" alt="Università di Pisa" />
            <h1>Università di Pisa</h1>
            <p>Offerta formativa — Dipartimenti di Agraria e di Scienze Veterinarie</p>
            <p class="hintCover">Suggerimento: scorri a destra per sfogliare il documento</p>
          </div>
        </div>
        <!-- Le pagine del PDF verranno aggiunte qui via JS -->
      </div>

      <!-- Overlay di caricamento -->
      <div class="loading" id="loading">
        <img src="marchio_unipi_pant541.png" alt="UniPi" />
        <div class="spinner" aria-hidden="true"></div>
        <p>Caricamento documento…</p>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const PDF_PATH = 'PAGAGRARIA.pdf';
    const stage = document.getElementById('stage');
    const track = document.getElementById('track');
    const loading = document.getElementById('loading');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageIndicator = document.getElementById('pageIndicator');

    // Nota: page 1 = COVER. Le pagine PDF partono da page 2.
    let pdfDoc = null, pdfPages = 0;
    let totalPages = 1; // cover
    let currentPage = 1;
    let pageWidth = 0;

    // Zoom
    const ZOOM_MIN = 1, ZOOM_MAX = 2.4;
    let zoom = 1, isPinching = false, lastDistance = 0;

    document.addEventListener('DOMContentLoaded', () => {
      loadPDF(); // carica subito
    });

    async function loadPDF(){
      try{
        pdfDoc = await pdfjsLib.getDocument({ url: PDF_PATH }).promise;
        pdfPages = pdfDoc.numPages;
        totalPages = 1 + pdfPages; // cover + pdf
        pageIndicator.textContent = `${currentPage} / ${totalPages}`;

        // Crea i contenitori per le pagine PDF (dalla 2 alla totalPages)
        for(let i=1;i<=pdfPages;i++){
          const pageDiv = document.createElement('div');
          pageDiv.className = 'page';
          const canvas = document.createElement('canvas');
          canvas.setAttribute('data-pdf-page', i); // indice delle pagine PDF
          pageDiv.appendChild(canvas);
          track.appendChild(pageDiv);
        }

        // Render iniziale
        await ensureRenderedPDF(1); // prima pagina del PDF (che corrisponde alla pagina "2" totale)
        await ensureRenderedPDF(2);
        loading.style.display = 'none';
        requestAnimationFrame(updateSizes);
        bindGestures();
      }catch(err){
        loading.querySelector('p').textContent = 'Errore nel caricamento del PDF';
        console.error(err);
      }
    }

    function updateSizes(){
      const stageRect = stage.getBoundingClientRect();
      pageWidth = stageRect.width;

      // riposiziona track sulla pagina corrente
      track.style.transform = `translateX(${ - (currentPage-1) * pageWidth }px)`;

      // ridisegna la pagina corrente (se è PDF)
      if(currentPage >= 2){
        const pdfIndex = currentPage - 1; // 1-based nel PDF
        renderPDFPage(pdfIndex, true);
        ensureRenderedPDF(pdfIndex+1);
        ensureRenderedPDF(pdfIndex-1);
      }
    }
    window.addEventListener('resize', updateSizes, {passive:true});

    // Rendering PDF che si adatta sia in altezza che in larghezza + pixelRatio per nitidezza
    async function renderPDFPage(pdfIndex, force=false){
      const canvas = track.querySelector(`canvas[data-pdf-page="${pdfIndex}"]`);
      if(!canvas) return;
      if(canvas._rendering && !force) return;
      canvas._rendering = true;

      const page = await pdfDoc.getPage(pdfIndex);
      const stageRect = stage.getBoundingClientRect();
      const base = page.getViewport({ scale: 1 });

      // Fit-to-screen: scegli il min tra scala per altezza e per larghezza
      const scaleH = (stageRect.height * 0.92) / base.height;
      const scaleW = (stageRect.width  * 0.94) / base.width;
      const scale = Math.max(1, Math.min(scaleH, scaleW)) * zoom;

      // Nitidezza su display ad alta densità
      const ratio = window.devicePixelRatio || 1;
      const viewport = page.getViewport({ scale: scale * ratio });

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      canvas.style.width = Math.floor(viewport.width / ratio) + "px";
      canvas.style.height = Math.floor(viewport.height / ratio) + "px";

      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      canvas._rendering = false;
      canvas._renderedOnce = true;
    }

    async function ensureRenderedPDF(pdfIndex){
      if(pdfIndex < 1 || pdfIndex > pdfPages) return;
      const canvas = track.querySelector(`canvas[data-pdf-page="${pdfIndex}"]`);
      if(canvas && !canvas._renderedOnce){
        await renderPDFPage(pdfIndex, true);
      }
    }

    function goTo(page, animate=true){
      if(page<1) page=1;
      if(page>totalPages) page=totalPages;
      currentPage = page;
      pageIndicator.textContent = `${currentPage} / ${totalPages}`;
      zoom = 1;

      track.style.transition = animate ? 'transform 280ms cubic-bezier(.22,.61,.36,1)' : 'none';
      track.style.transform = `translateX(${ - (currentPage-1) * pageWidth }px)`;

      if(currentPage >= 2){
        const pdfIndex = currentPage - 1;
        ensureRenderedPDF(pdfIndex);
        ensureRenderedPDF(pdfIndex+1);
        ensureRenderedPDF(pdfIndex-1);
        renderPDFPage(pdfIndex, true);
      }
    }

    // Controlli
    prevBtn.addEventListener('click', () => goTo(currentPage-1));
    nextBtn.addEventListener('click', () => goTo(currentPage+1));

    // Gesture: swipe + pinch zoom + doppio tap
    function bindGestures(){
      let startX=0, startY=0, dragging=false;

      stage.addEventListener('touchstart', (e) => {
        if(e.touches.length===1){
          dragging=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY;
          track.style.transition='none';
        } else if(e.touches.length===2){
          isPinching=true; lastDistance=distance(e.touches[0], e.touches[1]);
        }
      }, {passive:true});

      stage.addEventListener('touchmove', (e) => {
        if(isPinching && e.touches.length===2){
          const d = distance(e.touches[0], e.touches[1]);
          const factor = d / (lastDistance || d);
          lastDistance = d;
          const prevZoom = zoom;
          zoom = clamp(zoom * factor, ZOOM_MIN, ZOOM_MAX);
          if(currentPage>=2 && Math.abs(zoom - prevZoom) > 0.01){
            renderPDFPage(currentPage-1, true);
          }
          return;
        }
        if(!dragging || e.touches.length!==1) return;
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        if(Math.abs(dy) > Math.abs(dx) * 1.2) return;
        const targetX = - (currentPage-1) * pageWidth + dx;
        track.style.transform = `translateX(${targetX}px)`;
      }, {passive:true});

      stage.addEventListener('touchend', (e) => {
        if(isPinching && e.touches.length<2){ isPinching=false; return; }
        if(!dragging) return; dragging=false;
        const endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : startX;
        const delta = endX - startX;
        if(Math.abs(delta) > pageWidth * 0.18){
          if(delta < 0) goTo(currentPage+1); else goTo(currentPage-1);
        } else {
          goTo(currentPage, true);
        }
      }, {passive:true});

      // doppio tap per zoom
      let lastTap = 0;
      stage.addEventListener('touchend', (e) => {
        const now = Date.now();
        if(now - lastTap < 260 && !isPinching && currentPage>=2){
          zoom = (zoom>1.05) ? 1 : 1.8;
          renderPDFPage(currentPage-1, true);
        }
        lastTap = now;
      }, {passive:true});

      // Desktop drag
      let mDown=false, mStart=0;
      stage.addEventListener('mousedown', (e)=>{ mDown=true; mStart=e.clientX; track.style.transition='none'; });
      window.addEventListener('mousemove', (e)=>{
        if(!mDown) return;
        const dx = e.clientX - mStart;
        const targetX = - (currentPage-1) * pageWidth + dx;
        track.style.transform = `translateX(${targetX}px)`;
      });
      window.addEventListener('mouseup', (e)=>{
        if(!mDown) return; mDown=false;
        const delta = e.clientX - mStart;
        if(Math.abs(delta) > pageWidth*0.18){
          if(delta<0) goTo(currentPage+1); else goTo(currentPage-1);
        } else {
          goTo(currentPage,true);
        }
      });

      // Wheel orizzontale / Zoom con Ctrl+rotella
      stage.addEventListener('wheel', (e)=>{
        if(Math.abs(e.deltaX) > Math.abs(e.deltaY)){
          if(e.deltaX>0) goTo(currentPage+1); else goTo(currentPage-1);
        } else if (e.ctrlKey && currentPage>=2){
          e.preventDefault();
          const factor = (e.deltaY>0) ? 0.9 : 1.1;
          zoom = clamp(zoom * factor, ZOOM_MIN, ZOOM_MAX);
          renderPDFPage(currentPage-1, true);
        }
      }, {passive:false});

      // Tastiera
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowRight') goTo(currentPage+1);
        if(e.key === 'ArrowLeft')  goTo(currentPage-1);
        if((e.key === '+' || e.key === '=') && currentPage>=2){ zoom = clamp(zoom*1.1, ZOOM_MIN, ZOOM_MAX); renderPDFPage(currentPage-1,true); }
        if(e.key === '-' && currentPage>=2){ zoom = clamp(zoom*0.9, ZOOM_MIN, ZOOM_MAX); renderPDFPage(currentPage-1,true); }
      });
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function distance(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }
  })();
  </script>
</body>
</html>
